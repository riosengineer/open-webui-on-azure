<policies>
    <inbound>
        <base />
        <!-- Extract model from request body for custom metrics -->
        <set-variable name="model" value="@{
            var body = context.Request.Body?.As<JObject>(preserveContent: true);
            return body?[&quot;model&quot;]?.ToString() ?? &quot;unknown&quot;;
        }" />
        <!-- Azure AD token validation - requires parOpenWebUIAppId to be configured -->
        <validate-azure-ad-token tenant-id="{{tenant-id}}">
            <audiences>
                <audience>{{openwebui-app-id}}</audience>
            </audiences>
            <required-claims>
                <claim name="roles" match="any">
                    <value>admin</value>
                    <value>user</value>
                </claim>
            </required-claims>
        </validate-azure-ad-token>
        <!-- AI Gateway: Emit token metrics for analytics with model dimension -->
        <llm-emit-token-metric>
            <dimension name="Client IP address" value="@(context.Request.Headers.GetValueOrDefault(&quot;Authorization&quot;,&quot;&quot;).AsJwt()?.Claims.GetValueOrDefault(&quot;ipaddr&quot;, &quot;unknown&quot;))" />
            <dimension name="User ID" value="@(context.Request.Headers.GetValueOrDefault(&quot;Authorization&quot;,&quot;&quot;).AsJwt()?.Claims.GetValueOrDefault(&quot;preferred_username&quot;, &quot;anonymous&quot;))" />
            <dimension name="Model" value="@((string)context.Variables[&quot;model&quot;])" />
            <dimension name="Subscription ID" />
            <dimension name="API ID" />
        </llm-emit-token-metric>
        <!-- AI Gateway: Token rate limiting with prompt estimation -->
        <llm-token-limit tokens-per-minute="50000" estimate-prompt-tokens="true" counter-key="@(context.Subscription.Id)" tokens-consumed-header-name="consumed-tokens" remaining-tokens-header-name="remaining-tokens" />
        <set-backend-service backend-id="foundry-backend" />
        <authentication-managed-identity resource="https://cognitiveservices.azure.com" />
    </inbound>
    <backend>
        <base />
    </backend>
    <outbound>
        <base />
    </outbound>
    <on-error>
        <base />
    </on-error>
</policies>